---
title: "Fitting the COVID-19 curve"
author: "Artem Sokolov"
date: "Last Updated: `r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library( tidyverse )
```

```{r}
## Load the raw data
rawAll <- file.path("https://raw.githubusercontent.com/CSSEGISandData/COVID-19",
                  "master/csse_covid_19_data/csse_covid_19_time_series",
                  "time_series_19-covid-Confirmed.csv") %>%
  read_csv( col_types=cols() ) %>%
  rename( State = 1, Country = 2 )

## Identify the US slice
rawUS <- filter( rawAll, Country == "US" ) %>%
  select( -Lat, -Long, -Country ) %>%
  gather( Date, Confirmed, -State ) %>%
  mutate_at( "Date", lubridate::mdy )
```


```{r}
## Compute total and new confirmed cases for each day
computeNew <- function(X) {
  X %>% group_by( Date ) %>%
    summarize_at( "Confirmed", sum ) %>%
    arrange( Date ) %>%
    mutate( New = c(0,diff(Confirmed)) )
}

plotBase <- function(X) {
  X1 <- X %>% rename( Total = Confirmed ) %>%
    gather( Category, Confirmed, New, Total )
  ggplot( X1, aes(x=Date, y=Confirmed) ) +
    facet_wrap(~Category, nrow=1) + theme_bw() +
    geom_bar(stat="identity")
}
```

```{r}
## It appears that the most consistent tracking began around 2/27
## We'll use that for fitting
## For each day, compute the number of days since start of study
US <- computeNew(rawUS) %>% filter(Date >= lubridate::mdy("2/27/2020")) %>%
    mutate(nDays = as.integer(Date - lubridate::mdy("2/26/2020")))
plotBase(US) + ggtitle("US cases") +
    scale_y_continuous( trans = 'log10' )
```

```{r}
## Define the objective function
flnorm <- function(x, m, s, w, b) {w * dlnorm( x+b, m, s )}

fobj <- function(v)
{
    ypred <- flnorm( US$nDays, v[1], v[2], v[3], v[4] )
    err <- log(ypred+1) - log(US$New+1)
    sqrt(mean(err^2))
}

res <- optim( c(1,1,1,-5), fobj ) %>%
    .$par %>% set_names( c("m", "s", "w","b") ) %>%
    as.list()

X <- tibble( x=1:22 ) %>%
    mutate( y = dlnorm(x-5, 1, 2) )

ggplot( X, aes(x,y) ) + geom_line()

```
