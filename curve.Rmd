---
title: "Fitting the COVID-19 curve"
author: "Artem Sokolov"
date: "Last Updated: `r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library( tidyverse )
```

```{r echo=FALSE, warning=FALSE}
## Load the raw data
rawAll <- file.path("https://raw.githubusercontent.com/CSSEGISandData/COVID-19",
                  "master/csse_covid_19_data/csse_covid_19_time_series",
                  "time_series_19-covid-Confirmed.csv") %>%
  read_csv( col_types=cols() ) %>%
  rename( State = 1, Country = 2 )

## Identify the US slice
rawUS <- filter( rawAll, Country == "US" ) %>%
  select( -Lat, -Long, -Country ) %>%
  gather( Date, Confirmed, -State ) %>%
  na.omit() %>%
  mutate_at( "Date", lubridate::mdy )

## It appears that the most consistent tracking for the US began around 2/27
## Using the day before to remove the extra +/-1 in date arithmetic below
dStart <- lubridate::mdy("2/26/2020")

## Compute 1) new confirmed cases for each day and 
##         2) day offset from start date
US <- rawUS %>% group_by( Date ) %>%
  summarize_at( "Confirmed", sum ) %>%
  arrange( Date ) %>%
  mutate( New = c(0,diff(Confirmed)) ) %>%
  filter(Date > dStart)

## Fits a curve and generates predictions for k days forward
##   .df - data frame mapping Date -> Observation
##   obs - column in .df with observation values
##   f   - parametric distribution function
##   v0  - initial parameter estimates
##   k   - number of days to predict
fitCurve <- function( .df, obs, f, v0, k=5 ) {
  ## Compute day offset from start date
  .df <- .df %>% transmute( x = 1:n(), y = {{obs}} )
  
  ## Define the RMSE objective function
  fobj <- function(v) {(.df$y - f(.df$x, v))^2 %>% mean %>% sqrt}
  
  ## Optimize the objective function and compute predictions
  fit <- optim(v0, fobj)
  xp <- 1:(max(.df$x)+k)
  list( Pred = tibble( Date = dStart + lubridate::days(xp),
                       New = f(xp, fit$par) ),
        RMSE = fit$value )
}

## Define parametric distributions to fit to data
fgauss <- function(x, p) {p[1] * dnorm(x, p[2], p[3])}
flnorm <- function(x, m, s, w, b) {w * dlnorm(x-b, m, s)}

##optim( c(5,1,1e5,0), fobj2 )

## Define the starting parameters and fit curves
v0 <- c(max(US$New)*2, nrow(US), nrow(US)/2)
cgauss <- fitCurve( US, New, fgauss, v0 )

## Combine with observed data
P <- bind_rows( mutate(US,          Values="Observed"),
                mutate(cgauss$Pred, Values="Gaussian Fit") )

## Plot results
etxt <- function(s, ...) {element_text( size = s, face = "bold", ... )}
gg <- ggplot(mapping = aes(Date, New, fill=Values)) + theme_bw() +
  geom_bar( data=subset(P, Values=="Observed"), stat="identity" ) +
  geom_line( data=subset(P, Values=="Gaussian Fit"), color="tomato", size=1.25 ) +
  ylab( "New Cases in the U.S." ) +
  scale_fill_manual( values=c("Observed"="gray", "Gaussian Fit"="tomato") ) +
  scale_x_date(date_breaks="2 days", date_labels="%b %d") +
  theme( axis.text.y = etxt(12), axis.title = etxt(14),
         axis.text.x = etxt(12, angle=90, hjust=1, vjust=0.5),
         legend.text = etxt(12), legend.title = etxt(14) )

plotly::ggplotly(gg) %>% plotly::layout(legend = list(orientation="h", y=100))
```

References:

* Data: [CSSE at Johns Hopkins University](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data)

* Code: https://github.com/ArtemSokolov/covidcurve


